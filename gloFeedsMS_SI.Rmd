---
title: "Feed vs food supplemental information"
author: "Jessica Couture, Roland Geyer, Darcy Bradley, Ben Halpern, Steve Gaines"
output:
  pdf_document: default
  html_document:
    fig_width: 8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)

library(tidyverse)
library(kableExtra)
library(maps)
library(mapdata)
library(ggmap)
library(paletteer)
library(patchwork)

source("code/aqCalcs_prod_mat.R")

```

The figures and data here are the supplemental information for the manuscript "" on global feeds and livestock production by Jessica Couture, Roland Geyer, Darcy Bradley, Benjamin Halpern, and Steve Gaines. 

## Figure S1

```{r}

livFeeds<-read_csv("data/derived/wtdFeedProps_livestock.csv")

allComps<-livFeeds%>%
  group_by(product)%>%
  mutate(totFd=sum(globProp))%>%
  ungroup()%>%
  mutate(incl=globProp/totFd)%>%
  select(product,material, incl)%>%
  bind_rows(.,aqIn2018%>%
              mutate(product="aquaculture",
                     material=case_when(input == "fishmeal" ~ "Fish meal",
                                        input == "soybeanmeal" ~ "Soybean meal",
                                        input == "rapeseedmeal" ~ "Rapeseed meal",
                                        input == "wheat"  ~ "Wheat",
                                        input == "wheatbran"  ~ "Wheat bran",
                                        input == "maize"  ~ "Maize"))%>%
              select(product,material,incl))%>%
  mutate(product=factor(product,levels=c("cattle","sheep","goat","pig","chicken","aquaculture"),ordered = TRUE))

compsPlt<-ggplot(allComps,aes(product,incl,fill=material))+
  geom_col()+
  scale_y_continuous(expand=c(0,0))+
  labs(y="Inclusion")+
  theme_bw()


compsPlt

```

***

## Figure S2

Projection of production to 2050 based on current and recent trends in growth. Calculated based on total meat production from 1998-2018.

$$Production_{year} = \beta_{1}\ (year) + \beta_{0}$$

```{r prodDat}
livProd<-read_csv("faoDat/livestockFeeds/FAOSTAT_data_4-13-2021.csv") ## pulled data for the last 3 years: 2017,2018,2019 in case want to check out differences, start with 2019 tho --> replaced with all years of data in Aprilt

pcIngr<-read_csv("data/proteinContentLivestockInputs.csv")

livProd2<-livProd%>%
  mutate(product=str_replace(Item,"Meat, ",""))%>%
  filter(product %in% c("cattle","pig","chicken","sheep","goat"))%>%
  mutate(product=case_when(product %in% c("sheep","goat") ~ "smallRuminants",
                           TRUE ~ product))%>%
  group_by(Year,product)%>%
  summarise(gloProd=sum(Value,na.rm=TRUE))

glmFull<-read_csv("faoDat/livestockFeeds/GLEAM_Data_public_release_tab1.csv",skip = 1, locale = locale(encoding = "latin1"))
protInMeat<-data.frame(product=c("cattle","chicken","pig","goat","sheep"),
                       meatProt=c(0.175,0.186,0.166,0.175,0.175)) #fry corregendum, table 1 mean of ranges, cattle used as proxy for small rum.

edible<-data.frame(product=c("aquaculture","cattle","pig","chicken","smallRuminants"),
                   ediblePortion=c(0.86,0.43,0.72,0.74,0.79))

gf<-glmFull%>%
  filter(!Region=="Global",
         Commodity=="Meat")%>%
  select(Region,product=`Animal species`,system=`Production system`,protProd=`kg protein`)%>%
  mutate(protProd=as.numeric(str_replace_all(protProd,",","")))%>%
  filter(!system=="Aggregated",
         !product == "Buffaloes")%>%
  group_by(Region,product)%>%
  mutate(aggProd=sum(protProd))%>%
  ungroup()%>%
  mutate(propProd=protProd/aggProd)


### Divide production into production systems
gfGlo<-glmFull%>%
  filter(Region=="Global",
         Commodity=="Meat")%>%
  select(Region,product=`Animal species`,system=`Production system`,protProd=`kg protein`)%>%
  left_join(.,protInMeat)%>%
  mutate(protProd=as.numeric(str_replace_all(protProd,",","")),
         meatProt=replace_na(meatProt,1))%>%
  filter(!system=="Aggregated",
         !product == "Buffaloes")%>%
  group_by(Region,product)%>%
  mutate(aggProd=sum(protProd/meatProt))%>%
  ungroup()%>%
  mutate(propProd=protProd/aggProd,
         scale=case_when(system %in% c("Feedlots","Industrial systems","Layers","Broilers") ~ "industrial",
                         TRUE ~ "local"),
         product=tolower(product),
         product=case_when(product=="pigs" ~ "pig",
                           product=="goats" ~ "goat",
                           TRUE ~ product))%>%
  select(product,system,propProd,scale)

```

```{r }

### GLEAM feed rations data
## Pulled data for beef cattle, pork and poultry, but also have for: buffalo and small ruminants (sheep/goats)

livFeeds<-read_csv("data/derived/wtdFeedProps_livestock.csv")

## combine small ruminants and add to the data
smallRum<-livFeeds%>%
  filter(product %in% c("sheep","goat"))%>%
  group_by(material)%>%
  summarise(fdProp=mean(globProp))%>%
  mutate(product="smallRuminants")%>%
  select(product,material,globProp=fdProp)

livFeeds2<-bind_rows(livFeeds%>%
                       filter(product %in% c("cattle","pig","chicken")),
                     smallRum)%>%
  mutate(material=tolower(material))%>%
  left_join(.,data.frame(product=c("cattle","pig","chicken","smallRuminants"),
                         fcr=c(8,3.85,1.85,5)),by="product")%>% 
  left_join(.,edible,by="product")

## bring in CCI data we have so far, some pulled from lit, some from Couture et al., most fudged
cciDat<-read_csv("data/recipeCCIs.csv")%>%
  filter(!duplicated(ingredient))


### Make standard weighted feeds for top 5 products, combine sheep and goats into small rumin. --> 4 feeds

livFdPrp<-livProd2%>%
  full_join(.,livFeeds2)%>%
  mutate(matIncl=(gloProd/ediblePortion)*fcr*globProp)%>% ## input contribution based on 'globProp' GLEAM data proportions of animal feeds
  left_join(.,cciDat%>%
              mutate(material=tolower(ingredient))%>%
              select(material,cci=CCI_kg_kg))%>%
  mutate(cciContr=cci*matIncl)

protReq<-livFdPrp%>%
  filter(Year==2018,
         !duplicated(product))%>%
  mutate(feedReq=case_when(product=="cattle" ~ (gloProd/0.43)*8,
                            product=="pig" ~ (gloProd/0.72)*3.85,
                            product=="chicken" ~ (gloProd/0.74)*1.85,
                            TRUE ~ (gloProd/0.79)*5), # (meatProduction/ediblePortion) * FCR --> edible portion and FCR from Fry et al. 2018 correndum
         fdProt=case_when(product=="cattle" ~ feedReq*((7+15.4)/200),
                            product=="pig" ~ feedReq*((13+20.9)/200),
                            product=="chicken" ~ feedReq*((18+23)/200),
                            TRUE ~ feedReq*((10+14)/200)))%>%
  select(product,feedReq,fdProt)

protReq<-protReq[,2:4]

```


```{r}

prodCols<-paletteer_d("ghibli::PonyoMedium")[c(3,1,2,4,6)]
names(prodCols)<-c("aquaculture","smallRuminants","cattle","pig","chicken")

allDat<-aqYrs%>%
  mutate(product="aquaculture",
         fcr=1.6,
         ediblePortion=0.86)%>%
  select(Year=YEAR,
         product,
         gloProd=totProd,
         material=input,
         fcr,
         matIncl=inputContr,
         cci=cciPer,
         cciContr,
         ediblePortion)%>%
  bind_rows(.,livFdPrp%>%select(-globProp))%>%
  mutate(material=tolower(material))

currCI<-aqYrs%>%
  mutate(product="aquaculture")%>%
  select(product,Year=YEAR,inputContr,totCCI=cciContr)%>%
  bind_rows(.,livFdPrp%>%
              group_by(product,Year,matIncl)%>%
              summarise(totCCI=sum(cciContr))%>%
              rename(inputContr=matIncl))


meatProd<-aqProd%>%
  filter(!is.na(prod))%>%
  group_by(YEAR)%>%
  summarise(gloProd=sum(prod))%>%
  mutate(product="aquaculture")%>%
  select(Year=YEAR,product,gloProd)%>%
  bind_rows(.,livProd2)

yrsProdPlt<-meatProd%>%
  filter(Year<2019)%>%
  ggplot()+
  geom_col(aes(x=Year,y=gloProd/1000000,fill=product))+
  labs(y="Global production (mt)",title="Total production")+
  scale_y_continuous(expand = c(0,0))+
  theme_bw()

meatProj<-meatProd%>%
  filter(Year>1998,Year<2019)%>%
  group_by(Year)%>%
  summarise(totProd=sum(gloProd))

bauMtLm<-lm(totProd~Year,meatProj)

lmMtProj<-data.frame(Year=2000:2050)%>%
   mutate(meatProj=bauMtLm$coefficients[2][[1]]*Year+bauMtLm$coefficients[1][[1]],
          meatProjMt=meatProj/1000000)
 
coeffs<-expression(beta[1] * " = " * 9.21 * " x " * 10^6)

siProj<-yrsProdPlt+
  geom_line(data=lmMtProj,aes(Year,meatProjMt))+
  scale_fill_manual(values=prodCols)+
  scale_y_continuous(expand=c(0,0),limits=c(0,755))+
  theme_bw()+
  annotate(geom="text", x=1975, y=625, label=coeffs,
              color="black",size=6)

siProj
 
```

***

## Figure S3

Diet scenarios were calculated based on the below composition scenarios applied to total production levels projected above (Figure S1).


```{r}

percDat<-meatProd%>%
  filter(Year > 1960 & Year < 2019)%>%
  group_by(Year,product)%>%
  summarise(annProd=sum(gloProd))%>%
  group_by(Year)%>%
  mutate(totMeat=sum(annProd))%>%
  ungroup()%>%
  mutate(percContr=annProd/totMeat)%>%
  select(Year,product,percContr)

projPercDat<-data.frame(Year=rep(2019:2050,each=5),
                        product=rep(percDat%>%
                                       filter(Year==2018)%>%
                                       select(product)%>%
                                       as.vector()),
                        percContr=rep(percDat%>%
                                       filter(Year==2018)%>%
                                       select(percContr)%>%
                                       as.vector()))%>%
  bind_rows(percDat,.)%>%
  mutate(pCon=percContr*100)

BAT<-ggplot(projPercDat)+
  geom_vline(xintercept = 2020,color="gray65")+
  geom_line(aes(x=Year,y=pCon,color=product))+
  scale_color_manual(values = prodCols)+
  labs(y="Percent Contribution (%)",title = "Business as Today (BAT diets)")+
  theme_bw()

```
```{r, fig.width=12}

### Bringing in LUC data
lucDat<-read_csv("data/derived/lucValsKgCo2_Kg.csv")%>%
  mutate(luc=case_when(crop=="soybeans" ~ luc*1210/1000,
                       TRUE ~ luc),
         material=str_replace(crop,"soybeans","soybeanmeal"),
         luc=luc/1000)%>%
  select(material,luc,farming)

luc<-cciDat%>%
  mutate(material=tolower(str_replace_all(ingredient," ","")))%>%
  select(material,cci=CCI_kg_kg)%>%
  left_join(.,lucDat)%>%
  mutate(luc=replace_na(luc,0))


### MeatProd = lmSlope * (year) + lmIntercept

lm2018<-bauMtLm$coefficients[2][[1]]*2018+bauMtLm$coefficients[1][[1]]

## 2018 meat production rates in tonnes tonne: products

prodRates<-meatProd%>%
  filter(Year==2018)%>%
  mutate(totProd=sum(gloProd))%>%
  group_by(product)%>%
  summarise(productionRate=gloProd/totProd)


### calculate growth in production of each product from 2020-2050 based on lm total production

grth2050<-lmMtProj%>%
  filter(Year>=2019)%>%
  mutate(cattle=meatProj*prodRates[prodRates$product=="cattle","productionRate"][[1]],
         pig=meatProj*prodRates[prodRates$product=="pig","productionRate"][[1]],
         chicken=meatProj*prodRates[prodRates$product=="chicken","productionRate"][[1]],
         aquaculture=meatProj*prodRates[prodRates$product=="aquaculture","productionRate"][[1]],
         smallRuminants=meatProj*prodRates[prodRates$product=="smallRuminants","productionRate"][[1]])%>%
  select(-c(meatProjMt,meatProj))%>%
  pivot_longer(-Year,names_to = "product",values_to="prod")

### Bring in current data
projMeatProd<-bind_rows(meatProd%>%
                          filter(Year<2019)%>%
                          rename(prod=gloProd),
                        grth2050)

```


```{r, fig.width=12}
### calculate above by material

## 2018 production rates in tonnes per unit of meat production: products

prodRatesMat<-allDat%>%
  filter(Year==2018)%>%
  group_by(product,material)%>%
  summarise(perCapUse=sum(matIncl)/lm2018,
            perCapCci=sum(cciContr)/lm2018)%>%
  ungroup()


### calculate growth in material use from 2020-2050 based on lm projection

grth2050mat<-lmMtProj%>%
  filter(Year>=2019)%>%
  select(Year,meatProj)%>%
  #mutate(grthPop=meatProj-pop2018)%>%
  crossing(.,prodRatesMat)%>%
  mutate(projProd=meatProj*perCapUse,
         projCCI=meatProj*perCapCci)

### Bring in current data
projMatCci<-bind_rows(allDat%>%
                         filter(Year==2018)%>%
                         select(Year,product,material,matIncl,cciContr),
                       grth2050mat%>%
                         select(Year,product,material,matIncl=projProd,cciContr=projCCI))%>%
  mutate(material=tolower(str_replace_all(material," ","")))

projMatLuc<-projMatCci%>%
  group_by(Year,material)%>%
  summarise(mat=sum(matIncl))%>%
  ungroup()%>%
  left_join(.,projMatCci%>%
              filter(Year==2018)%>%
              mutate(material=tolower(str_replace_all(material," ","")))%>%
              group_by(material)%>%
              summarise(mat2018=sum(matIncl)))%>%
  left_join(.,luc%>%
              filter(farming%in%c("conventionalTill",NA))%>%
              mutate(lucCci=cci+luc)%>%
              select(!farming),
            by="material")%>%
  mutate(matGrow=mat-mat2018,
         cciGrow=matGrow*lucCci,
         cciSame=mat2018*cci,
         cciProj=cciSame+cciGrow)

projMatLucNT<-projMatCci%>%
  group_by(Year,material)%>%
  summarise(mat=sum(matIncl))%>%
  ungroup()%>%
  left_join(.,projMatCci%>%
              filter(Year==2018)%>%
              mutate(material=tolower(str_replace_all(material," ","")))%>%
              group_by(material)%>%
              summarise(mat2018=sum(matIncl)))%>%
  left_join(.,luc%>%
              filter(farming%in%c("noTill",NA))%>%
              mutate(lucCci=cci+luc)%>%
              select(!farming),
            by="material")%>%
  mutate(matGrow=mat-mat2018,
         cciGrow=matGrow*lucCci,
         cciSame=mat2018*cci,
         cciProj=cciSame+cciGrow)


#### Soy growth (BAT)

# Project protein needs

prot2018<-projMatCci%>%
  filter(Year==2018)%>%
  left_join(.,pcIngr%>%
              mutate(material=tolower(str_replace_all(ingredient," ","")))%>%
              select(material,pc=`PC middle`),by="material")%>%
  mutate(prot=matIncl*pc/100)%>%
  summarise(totProt=sum(prot))%>%
  select(totProt)%>%
  as.numeric()

## calculate how much additional protein will be needed to meet projected growth
proteinProjAdd<-projMatCci%>%
  left_join(.,pcIngr%>%
              mutate(material=tolower(str_replace_all(ingredient," ","")))%>%
              select(material,pc=`PC middle`),by="material")%>%
  mutate(protYr=matIncl*pc/100)%>%
  group_by(Year)%>%
  summarise(totPC=sum(protYr))%>%
  mutate(protAdd=totPC-prot2018)


### base DF with 2018 materials thru 2050, add growth from 2020-2050

baseDf<-projMatCci%>%
  filter(Year==2018)%>%
  select(-Year)

scenProjBase<-as.data.frame(lapply(baseDf,rep,length(2018:2050)))%>%
  mutate(Year=rep(2018:2050,each=nrow(baseDf)))

soyLUCtill<-luc[luc$material=="soybeanmeal" & luc$farming=="conventionalTill","luc"][[1]]
soyLUCnt<-luc[luc$material=="soybeanmeal" & luc$farming=="noTill","luc"][[1]]

soyProjDf<-proteinProjAdd%>%
  mutate(soyAdd=protAdd/0.46,
         cci=soyAdd*soyLUCtill,
         cciNT=soyAdd*soyLUCnt)%>%
  mutate(material="soybeanmeal")%>%
  select(Year,material,cci,cciNT)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cci=sum(cciContr))%>%
              mutate(cciNT=cci))

soyProj2<-soyProjDf%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cci),
            totCCInt=sum(cciNT))%>%
  mutate(scenario="soy growth")


cciSoyPlt<-ggplot(soyProj2)+
  geom_line(aes(x=Year,y=totCCI/1000000))+
  #geom_vline(xintercept = 2020)+
  scale_y_continuous(expand = c(0,0))+
  theme_bw()


#### Bacteria growth (BAT)

bactProjDf<-proteinProjAdd%>%
  mutate(bactAdd=protAdd/0.7,
         cci=bactAdd*8.62)%>%
  mutate(material="bacteria meal")%>%
  select(Year,material,cci)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cci=sum(cciContr)))

bactProj2<-bactProjDf%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cci))%>%
  mutate(scenario="bacteria growth")


#### Yeast growth (BAT)


yeastProjDf<-proteinProjAdd%>%
  mutate(ypcAdd=protAdd/0.75,
         ystAdd=protAdd/0.5,
         cciYPC=ystAdd*0.58, # tallentire process modeled in gabi
         cciYst=ystAdd*0.8)%>% # ave of a few data sources: ecoinvent, cafalec LCA, etc. 
  mutate(material="yeast meal")%>%
  select(Year,material,cciYPC,cciYst)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cciYPC=sum(cciContr),
                        cciYst=sum(cciContr)))

yeastProj2<-yeastProjDf%>%
  group_by(Year)%>%
  summarise(totCCIpc=sum(cciYPC),
            totCCIml=sum(cciYst))%>%
  mutate(scenario="yeast growth")


### Growth scenarios: CCI (BAT)

projScens<-projMatLuc%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cciProj))%>%
  mutate(scenario="BAU",
         production="conventional")%>%
  bind_rows(projMatLucNT%>%
              group_by(Year)%>%
              summarise(totCCI=sum(cciProj))%>%
              mutate(scenario="BAU",
                     production="alternative"))%>%
  bind_rows(.,soyProj2%>%
              select(Year,totCCI,scenario)%>%
              mutate(production="conventional"),
            soyProj2%>%
              select(Year,totCCI=totCCInt,scenario)%>%
              mutate(production="alternative"),
            bactProj2%>%
              mutate(production="conventional"),
            yeastProj2%>%
              select(Year,totCCI=totCCIml,scenario)%>%
              mutate(production="conventional"),
            yeastProj2%>%
              select(Year,totCCI=totCCIpc,scenario)%>%
              mutate(production="alternative"))%>%
  mutate(production=factor(production,levels=c("conventional","alternative"),ordered=TRUE))

fdScenCols<-c(paletteer_d("ghibli::YesterdayMedium")[c(1,5,6)],
              paletteer_d("ghibli::MononokeMedium")[6])
names(fdScenCols)<-c("BAU","soy growth","yeast growth","bacteria growth")

scensPlt<-ggplot()+
  #geom_col(data=projMatCci[projMatCci$Year==2018,],aes(Year,cciContr/1000000,fill=material))+
  geom_line(data=projScens,aes(Year,totCCI/1000000,color=scenario,linetype=production))+
  scale_color_manual(values = fdScenCols)+
  scale_y_continuous(expand=c(0,0),limits=c(0,5750))+
  # scale_x_continuous(breaks=c(2018,2020,2030,2040,2050),labels = c(2018,2020,2030,2040,2050))+
  labs(y=expression(paste("GHG (mt", CO[2],"eq.)",sep=" ")),title="BAT diets")+
  theme_bw()

```

```{r}

percCowDat<-percDat%>%
  filter(Year>1998,product=="cattle")

percCowLm<-lm(percContr~Year,percCowDat)

lmCowProj<-data.frame(Year=2000:2050)%>%
   mutate(product="cattle",
          percContr=percCowLm$coefficients[2][[1]]*Year+percCowLm$coefficients[1][[1]])

### pig

percPigDat<-percDat%>%
  filter(Year>1998,product=="pig")

percPigLm<-lm(percContr~Year,percPigDat)

lmPigProj<-data.frame(Year=2000:2050)%>%
   mutate(product="pig",
          percContr=percPigLm$coefficients[2][[1]]*Year+percPigLm$coefficients[1][[1]])
 
### chicken

percChknDat<-percDat%>%
  filter(Year>1998,product=="chicken")

percChknLm<-lm(percContr~Year,percChknDat)

lmChknProj<-data.frame(Year=2000:2050)%>%
   mutate(product="chicken",
          percContr=percChknLm$coefficients[2][[1]]*Year+percChknLm$coefficients[1][[1]])
 

### aquaculture

percAquaDat<-percDat%>%
  filter(Year>1998,product=="aquaculture")

percAqLm<-lm(percContr~Year,percAquaDat)

lmAqProj<-data.frame(Year=2000:2050)%>%
   mutate(product="aquaculture",
          percContr=percAqLm$coefficients[2][[1]]*Year+percAqLm$coefficients[1][[1]])
 
### small Rums
 
percSrDat<-percDat%>%
  filter(Year>1998,product=="smallRuminants")

percSrLm<-lm(percContr~Year,percSrDat)

lmSrProj<-data.frame(Year=2000:2050)%>%
   mutate(product="smallRuminants",
          percContr=percSrLm$coefficients[2][[1]]*Year+percSrLm$coefficients[1][[1]])

### Add projections to historic data

percDatProj<-percDat%>%
  select(Year,product,percContr)%>%
  bind_rows(.,bind_rows(lmCowProj,lmPigProj,lmChknProj,lmAqProj,lmSrProj)%>%
              filter(Year>2018))

BAU<-ggplot(percDatProj)+
  geom_vline(xintercept = 2020,color="gray65")+
  geom_line(aes(x=Year,y=percContr*100,color=product))+
  scale_color_manual(values = prodCols)+
  labs(y="Percent Contribution (%)",title = "Business as Usual (BAU diets)")+
  theme_bw()

```

```{r}

grth2050Diets<-lmMtProj%>%
  filter(Year >= 2019)%>%
  left_join(percDatProj%>%
              filter(Year>=2019),.)%>%
  select(-meatProjMt)%>%
  mutate(production=percContr*meatProj)%>%
  bind_rows(.,meatProd%>%
              filter(Year<2019)%>%
              rename(production=gloProd))


livFeeds3<-livFeeds2%>%
  bind_rows(.,aqIn2018%>%
              mutate(product="aquaculture",
                     fcr=1.6,
                     ediblePortion=0.86)%>%
              select(product,material=input,globProp=incl,fcr,ediblePortion))

## 2018 production rates in tonnes per person: products

prod2050Mat<-grth2050Diets%>%
  filter(Year>2017)%>%
  full_join(.,livFeeds3)%>%
  mutate(matIncl=(production/ediblePortion)*fcr*globProp)

### old stuff from above 

prod2050MatLUC<-prod2050Mat%>%
  mutate(material=tolower(str_replace_all(material," ","")))%>%
  group_by(Year,material)%>%
  summarise(mat=sum(matIncl))%>%
  ungroup()%>%
  left_join(.,projMatCci%>%
              filter(Year==2018)%>%
              mutate(material=tolower(str_replace_all(material," ","")))%>%
              group_by(material)%>%
              summarise(mat2018=sum(matIncl)))%>%
  left_join(.,luc%>%
              filter(farming %in% c("conventionalTill",NA))%>%
              mutate(lucCci=cci+luc)%>%
              select(!farming),
            by="material")%>%
  mutate(matGrow=mat-mat2018,
         matGrow=case_when(matGrow<0.1 ~ 0, 
                           TRUE ~ matGrow),
         cciGrow=matGrow*lucCci,
         cciSame=mat2018*cci,
         cciProj=cciSame+cciGrow)

prod2050MatLUCnt<-prod2050Mat%>%
  mutate(material=tolower(str_replace_all(material," ","")))%>%
  group_by(Year,material)%>%
  summarise(mat=sum(matIncl))%>%
  ungroup()%>%
  left_join(.,projMatCci%>%
              filter(Year==2018)%>%
              mutate(material=tolower(str_replace_all(material," ","")))%>%
              group_by(material)%>%
              summarise(mat2018=sum(matIncl)))%>%
  left_join(.,luc%>%
              filter(farming %in% c("noTill",NA))%>%
              mutate(lucCci=cci+luc)%>%
              select(!farming),
            by="material")%>%
  mutate(matGrow=mat-mat2018,
         matGrow=case_when(matGrow<0.1 ~ 0, 
                           TRUE ~ matGrow),
         cciGrow=matGrow*lucCci,
         cciSame=mat2018*cci,
         cciProj=cciSame+cciGrow)

```


```{r}

# Project protein needs
## prot2018 # is the amt protein needed to feed meet produced in 2018

#### Soy growth (BAU)

## calculate how much additional protein will be needed to meet projected growth
proteinProjAdd_diets<-prod2050Mat%>%
  mutate(material=tolower(str_replace_all(material," ","")))%>%
  left_join(.,pcIngr%>%
              mutate(material=tolower(str_replace_all(ingredient," ","")))%>%
              select(material,pc=`PC middle`),by="material")%>%
  mutate(protYr=matIncl*pc/100)%>%
  group_by(Year)%>%
  summarise(totPC=sum(protYr))%>%
  mutate(protAdd=totPC-prot2018)

soyProjDf_D<-proteinProjAdd_diets%>%
  mutate(soyAdd=protAdd/0.46,
         cci=soyAdd*soyLUCtill,
         cciNT=soyAdd*soyLUCnt)%>%
  mutate(material="soybeanmeal")%>%
  select(Year,material,cci,cciNT)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cci=sum(cciContr))%>%
              mutate(cciNT=cci))

soyProj_D2<-soyProjDf_D%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cci),
            totCCInt=sum(cciNT))%>%
  mutate(scenario="soy growth")

### BACTERIA GROWTH (BAU)

bactProjDf_D<-proteinProjAdd_diets%>%
  mutate(bactAdd=protAdd/0.7,
         cci=bactAdd*8.62)%>%
  mutate(material="bacteria meal")%>%
  select(Year,material,cci)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cci=sum(cciContr)))

bactProj_D2<-bactProjDf_D%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cci))%>%
  mutate(scenario="bacteria growth")

  
### YEAST GROWTH (BAU)

yeastProjDf_D<-proteinProjAdd_diets%>%
    mutate(ypcAdd=protAdd/0.75,
         ystAdd=protAdd/0.5,
         cciYPC=ystAdd*0.58, # tallentire process modeled in gabi
         cciYst=ystAdd*0.8)%>% # ave of a few data sources: ecoinvent, cafalec LCA, etc. 
  mutate(material="yeast meal")%>%
  select(Year,material,cciYPC,cciYst)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cciYPC=sum(cciContr),
                        cciYst=sum(cciContr)))

yeastProj_D2<-yeastProjDf_D%>%
  group_by(Year)%>%
  summarise(totCCIpc=sum(cciYPC),
            totCCIml=sum(cciYst))%>%
  mutate(scenario="yeast growth")


### CCI growth scenarios (BAU)

projScensD<-prod2050MatLUC%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cciProj))%>%
  mutate(scenario="BAU",
         production="conventional")%>%
  bind_rows(prod2050MatLUCnt%>%
              group_by(Year)%>%
              summarise(totCCI=sum(cciProj))%>%
              mutate(scenario="BAU",
                     production="alternative"))%>%
  bind_rows(.,soyProj_D2%>%
              select(Year,totCCI,scenario)%>%
              mutate(production="conventional"),
            soyProj_D2%>%
              select(Year,totCCI=totCCInt,scenario)%>%
              mutate(production="alternative"),
            bactProj_D2%>%
            mutate(production="conventional"),
            yeastProj_D2%>%
              select(Year,totCCI=totCCIml,scenario)%>%
              mutate(production="conventional"),
            yeastProj_D2%>%
              select(Year,totCCI=totCCIpc,scenario)%>%
              mutate(production="alternative"))%>%
  mutate(production=factor(production,levels=c("conventional","alternative"),ordered=TRUE))

scensPlt_D<-ggplot()+
  # geom_col(data=projMatCci[projMatCci$Year==2018,],aes(Year,cciContr/1000000,fill=material))+
  geom_line(data=projScensD,aes(Year,totCCI/1000000,color=scenario,linetype=production))+
  scale_color_manual(values = fdScenCols)+
  scale_y_continuous(expand=c(0,0),limits=c(0,5750))+
  # scale_x_continuous(breaks=c(2018,2020,2030,2040,2050),labels = c(2018,2020,2030,2040,2050))+
  labs(y="",title="BAU diets")+
  theme_bw()

```


```{r}

## Shifting diets 2x

##### Meat contribution trends 2x


cowM<-percCowLm$coefficients[2][[1]]*2

cowB<-percDat[percDat$Year==2018 & percDat$product=="cattle","percContr"][[1]]-cowM*2018

lmCowProj2<-data.frame(Year=2000:2050)%>%
   mutate(product="cattle",
          percContr=cowM*Year+cowB,
          percContr=case_when(percContr < 0 ~ 0,
                              TRUE ~ percContr))

### pig

pigM<-percPigLm$coefficients[2][[1]]*2

pigB<-percDat[percDat$Year==2018 & percDat$product=="pig","percContr"][[1]]-pigM*2018

lmPigProj2<-data.frame(Year=2000:2050)%>%
   mutate(product="pig",
          percContr=pigM*Year+pigB)


 
### chicken

chknM<-percChknLm$coefficients[2][[1]]*2

chknB<-percDat[percDat$Year==2018 & percDat$product=="chicken","percContr"][[1]]-chknM*2018

lmChknProj2<-data.frame(Year=2000:2050)%>%
   mutate(product="chicken",
          percContr=chknM*Year+chknB)
 

### aquaculture

aqM<-percAqLm$coefficients[2][[1]]*2

aqB<-percDat[percDat$Year==2018 & percDat$product=="aquaculture","percContr"][[1]]-aqM*2018

lmAqProj2<-data.frame(Year=2000:2050)%>%
   mutate(product="aquaculture",
          percContr=aqM*Year+aqB)
 
### small Rums
 
srM<-percSrLm$coefficients[2][[1]]*2

srB<-percDat[percDat$Year==2018 & percDat$product=="smallRuminants","percContr"][[1]]-srM*2018

lmSrProj2<-data.frame(Year=2000:2050)%>%
   mutate(product="smallRuminants",
          percContr=srM*Year+srB)

### Add projections to historic data

percDatProj2<-percDat%>%
  select(Year,product,percContr)%>%
  bind_rows(.,bind_rows(lmCowProj2,lmPigProj2,lmChknProj2,lmAqProj2,lmSrProj2)%>%
              filter(Year>2018))

percDatProj2[percDatProj2$Year>2046 & percDatProj2$product %in% c("aquaculture","pig","chicken","smallRuminants"),"percContr"]<-percDatProj2[percDatProj2$Year>2046 & percDatProj2$product %in% c("aquaculture","pig","chicken","smallRuminants"),"percContr"][[1]]-0.0025

percDatProj2[percDatProj2$Year>2048 & percDatProj2$product %in% c("aquaculture","pig","chicken","smallRuminants"),"percContr"]<-percDatProj2[percDatProj2$Year>2048 & percDatProj2$product %in% c("aquaculture","pig","chicken","smallRuminants"),"percContr"][[1]]-0.0025

ADS<-ggplot(percDatProj2)+
  geom_vline(xintercept = 2020,color="gray65")+
  geom_line(aes(x=Year,y=percContr*100,color=product))+
    scale_color_manual(values = prodCols)+
  labs(y="Percent Contribution (%)",title = "Accelerating diet shifts (ADS diets)")+
  theme_bw()
```

```{r fig.height=15}

(BAT/BAU/ADS) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect")

```


```{r}

grth2050Diets2<-lmMtProj%>%
  filter(Year >= 2019)%>%
  left_join(percDatProj2%>%
              filter(Year>=2019),.)%>%
  select(-meatProjMt)%>%
  mutate(production=percContr*meatProj)%>%
  bind_rows(.,meatProd%>%
              filter(Year<2019)%>%
              rename(production=gloProd))



prod2050Mat2<-grth2050Diets2%>%
  filter(Year>2017)%>%
  full_join(.,livFeeds3)%>%
  mutate(matIncl=(production/ediblePortion)*fcr*globProp)

### calculation GWP impacts


prod2050MatLUC2<-prod2050Mat2%>%
  mutate(material=tolower(str_replace_all(material," ","")))%>%
  group_by(Year,material)%>%
  summarise(mat=sum(matIncl))%>%
  ungroup()%>%
  left_join(.,projMatCci%>%
              filter(Year==2018)%>%
              mutate(material=tolower(str_replace_all(material," ","")))%>%
              group_by(material)%>%
              summarise(mat2018=sum(matIncl)))%>%
  left_join(.,luc%>%
              filter(farming%in%c("conventionalTill",NA))%>%
              mutate(lucCci=cci+luc)%>%
              select(!farming),
            by="material")%>%
  mutate(matGrow=mat-mat2018,
         matGrow=case_when(matGrow<0 ~ 0, 
                           TRUE ~ matGrow),
         cciGrow=matGrow*lucCci,
         cciSame=mat2018*cci,
         cciProj=cciSame+cciGrow)


prod2050MatLUCnt2<-prod2050Mat2%>%
  mutate(material=tolower(str_replace_all(material," ","")))%>%
  group_by(Year,material)%>%
  summarise(mat=sum(matIncl))%>%
  ungroup()%>%
  left_join(.,projMatCci%>%
              filter(Year==2018)%>%
              mutate(material=tolower(str_replace_all(material," ","")))%>%
              group_by(material)%>%
              summarise(mat2018=sum(matIncl)))%>%
  left_join(.,luc%>%
              filter(farming%in%c("noTill",NA))%>%
              mutate(lucCci=cci+luc)%>%
              select(!farming),
            by="material")%>%
  mutate(matGrow=mat-mat2018,
         matGrow=case_when(matGrow<0 ~ 0, 
                           TRUE ~ matGrow),
         cciGrow=matGrow*lucCci,
         cciSame=mat2018*cci,
         cciProj=cciSame+cciGrow)


#### Soy growth (ADS)


# Project protein needs
## prot2018 # is the amt protein needed to feed meet produced in 2018

## calculate how much additional protein will be needed to meet projected growth
proteinProjAdd_diets2<-prod2050Mat2%>%
  mutate(material=tolower(str_replace_all(material," ","")))%>%
  left_join(.,pcIngr%>%
              mutate(material=tolower(str_replace_all(ingredient," ","")))%>%
              select(material,pc=`PC middle`),by="material")%>%
  mutate(protYr=matIncl*pc/100)%>%
  group_by(Year)%>%
  summarise(totPC=sum(protYr))%>%
  mutate(protAdd=totPC-prot2018)


### base DF with 2018 materials thru 2050, add growth from 2020-2050

# baseDf<-projMatCci%>%
#   filter(Year==2018)%>%
#   select(-Year)
# 
# scenProjBase<-as.data.frame(lapply(baseDf,rep,length(2018:2050)))%>%
#   mutate(Year=rep(2018:2050,each=nrow(baseDf)))

soyProjDf_D2<-proteinProjAdd_diets2%>%
  mutate(soyAdd=protAdd/0.46,
         cci=soyAdd*soyLUCtill,
         cciNT=soyAdd*soyLUCnt)%>%
  mutate(material="soybeanmeal")%>%
  select(Year,material,cci,cciNT)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cci=sum(cciContr))%>%
              mutate(cciNT=cci))

soyProj_D22<-soyProjDf_D2%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cci),
            totCCInt=sum(cciNT))%>%
  mutate(scenario="soy growth")


cciSoyPlt_D2<-ggplot(soyProj_D22)+
  geom_line(aes(x=Year,y=totCCI/1000000))+
  #geom_vline(xintercept = 2020)+
  scale_y_continuous(expand = c(0,0))+
  theme_bw()


#### Bacteria growth (ADS)


bactProjDf_D2<-proteinProjAdd_diets2%>%
  mutate(bactAdd=protAdd/0.7,
         cci=bactAdd*8.62)%>% #calysta data modeled in gabi
  mutate(material="bacteria meal")%>%
  select(Year,material,cci)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cci=sum(cciContr)))

bactProj_D22<-bactProjDf_D2%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cci))%>%
  mutate(scenario="bacteria growth")


#### Yeast growth (ADS)


yeastProjDf_D2<-proteinProjAdd_diets2%>%
  mutate(ypcAdd=protAdd/0.75,
         ystAdd=protAdd/0.5,
         cciYPC=ypcAdd*0.58, # tallentire process modeled in gabi
         cciYst=ystAdd*0.8)%>% # ave of a few data sources: ecoinvent, cafalec LCA, etc. 
  mutate(material="yeast meal")%>%
  select(Year,material,cciYPC,cciYst)%>%
  bind_rows(.,scenProjBase%>%
              group_by(Year,material)%>%
              summarise(cciYPC=sum(cciContr),
                        cciYst=sum(cciContr)))

yeastProj_D22<-yeastProjDf_D2%>%
  group_by(Year)%>%
  summarise(totCCIpc=sum(cciYPC),
            totCCIml=sum(cciYst))%>%
  mutate(scenario="yeast growth")


### Growth scenarios: CCI (ADS)


projScens_D2<-prod2050MatLUC2%>%
  group_by(Year)%>%
  summarise(totCCI=sum(cciProj))%>%
  mutate(scenario="BAU",
         production="conventional")%>%
  bind_rows(prod2050MatLUCnt2%>%
              group_by(Year)%>%
              summarise(totCCI=sum(cciProj))%>%
              mutate(scenario="BAU",
                     production="alternative"))%>%
  bind_rows(.,soyProj_D22%>%
              select(Year,totCCI,scenario)%>%
              mutate(production="conventional"),
            soyProj_D22%>%
              select(Year,totCCI=totCCInt,scenario)%>%
              mutate(production="alternative"),
            bactProj_D22%>%
              mutate(production="conventional"),
            yeastProj_D22%>%
              select(Year,totCCI=totCCIml,scenario)%>%
              mutate(production="conventional"),
            yeastProj_D22%>%
              select(Year,totCCI=totCCIpc,scenario)%>%
              mutate(production="alternative"))%>%
  mutate(production=factor(production,levels=c("conventional","alternative"),ordered=TRUE))

scensPlt_D2<-ggplot()+
  # geom_col(data=projMatCci[projMatCci$Year==2018,],aes(Year,cciContr/1000000,fill=material))+
  geom_line(data=projScens_D2,aes(Year,totCCI/1000000,color=scenario,linetype=production))+
  scale_color_manual(values = fdScenCols)+
  scale_y_continuous(expand=c(0,0),limits=c(0,5750))+
  # scale_x_continuous(breaks=c(2018,2020,2030,2040,2050),labels = c(2018,2020,2030,2040,2050))+
  labs(y="",title="ADS diets")+
  theme_bw()

```

```{r, fig.width=12}


### Emissions from other production sources

prodGHG<-data.frame(product=c("cattle","pig","chicken","smallRuminants","aquaculture"),
                    ghgIntensity=c(25.51,1.48,0.56,25.845,1.55),
                    percFeed=c(0.10,0.50,0.50,0.10,0.57))%>%
  mutate(eos=ghgIntensity*(1-percFeed))

### Business as today

eosBat<-projMeatProd%>%
  filter(Year>=2018)%>%
  left_join(.,prodGHG,by="product")%>%
  mutate(totalEOS=prod*eos)%>%
  group_by(Year)%>%
  summarise(totEOS=sum(totalEOS))

prodEmiss<-projScens%>%
  left_join(.,eosBat,by="Year")%>%
  mutate(totGHG=totCCI+totEOS)

scensPltProd<-ggplot()+
  geom_line(data=prodEmiss,aes(Year,totGHG/1000000,color=scenario,linetype=production))+
  scale_color_manual(values = fdScenCols)+
  scale_y_continuous(expand=c(0,0),limits=c(0,10000))+ 
  # scale_x_continuous(breaks=c(2018,2020,2030,2040,2050),labels = c(2018,2020,2030,2040,2050))+
  labs(y=expression(paste("GHG (mt", CO[2],"eq.)",sep=" ")),title="")+
  theme_bw()

```

```{r}

### Shifts as usual

### Emissions from other production sources

eosSau<-grth2050Diets%>%
  filter(Year>=2018)%>%
  left_join(.,prodGHG,by="product")%>%
  mutate(totalEOS=production*eos)%>%
  group_by(Year)%>%
  summarise(totEOS=sum(totalEOS))

prodEmissD<-projScensD%>%
  left_join(.,eosSau,by="Year")%>%
  mutate(totGHG=totCCI+totEOS)

scensPltProdD<-ggplot()+
  geom_line(data=prodEmissD,aes(Year,totGHG/1000000,color=scenario,linetype=production))+
  scale_color_manual(values = fdScenCols)+
  scale_y_continuous(expand=c(0,0),limits=c(0,10000))+ 
  # scale_x_continuous(breaks=c(2018,2020,2030,2040,2050),labels = c(2018,2020,2030,2040,2050))+
  labs(y="",title="")+
  theme_bw()

```

```{r}

### Double the shifts

eosS2<-grth2050Diets2%>%
  filter(Year>=2018)%>%
  left_join(.,prodGHG,by="product")%>%
  mutate(totalEOS=production*eos)%>%
  group_by(Year)%>%
  summarise(totEOS=sum(totalEOS))

prodEmissD2<-projScens_D2%>%
  left_join(.,eosS2,by="Year")%>%
  mutate(totGHG=totCCI+totEOS)

scensPltProdD2<-ggplot()+
  geom_line(data=prodEmissD2,aes(Year,totGHG/1000000,color=scenario,linetype=production))+
  scale_color_manual(values = fdScenCols)+
  scale_y_continuous(expand=c(0,0),limits=c(0,10000))+ 
  # scale_x_continuous(breaks=c(2018,2020,2030,2040,2050),labels = c(2018,2020,2030,2040,2050))+
  labs(y="",title="")+
  theme_bw()

```

***
## Figure S4

```{r fig.height=9,fig.width=12}

((scensPlt+scensPlt_D+scensPlt_D2)/(scensPltProd + scensPltProdD + scensPltProdD2)) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect")

```

